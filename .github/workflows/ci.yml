name: GeoIntel Otomatik Test

on:
  push:
    branches: [ "main" ]

jobs:
  test-yap:
    runs-on: ubuntu-latest

    # YENİ BÖLÜM: SAHTE ANAHTARLAR (Test sırasında Pydantic patlamasın diye)
    env:
      DATABASE_URL: "postgresql://user:pass@localhost:5432/testdb"
      OPENWEATHER_API_KEY: "test_key"
      HERE_API_KEY: "test_key"
      GOOGLE_MAPS_API_KEY: "test_key"

    steps:
    - uses: actions/checkout@v3

    - name: Python Kuruluyor
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Kütüphaneler Yükleniyor
      run: |
        python -m pip install --upgrade pip
        pip install pytest httpx asyncpg pydantic pydantic-settings fastapi uvicorn polyline loguru

    # KRİTİK DÜZELTME BURADA:
    # PYTHONPATH'e alt klasörleri de ekliyoruz ki 'import config' çalışsın.
    - name: Yollar Tanımlanıyor
      run: |
        echo "PYTHONPATH=$PYTHONPATH:$(pwd):$(pwd)/services/mcp_city" >> $GITHUB_ENV

    - name: Testler Çalışıyor
      run: |
        pytest tests/